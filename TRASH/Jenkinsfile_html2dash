/* Created by Jeremie CUADRADO
 Under GNU AFFERO GENERAL PUBLIC LICENSE
*/

pipeline {
    agent any


    environment {
        branchName = 'master'
        docker_mkdocs_image = 'redbeard28/docker_mkdocs:0.4'
        DOCS_PATH = 'release'
        DOCSET_NAME = 'redbeard28'
    }

    stages{
        stage('Clone the GitHub repo'){
            steps{
                git url: "https://github.com/redbeard28/dockset.git", branch: "${branchName}", credentialsId: "jenkins_github_pat"
            }
            post{
                success{
                    echo 'Successfuly clone your repo...'
                }
            }
        }
        stage('Stop the actual container...'){

            steps{
                script{
                    close_container()
                }
            }
        }
        stage('Generate HTML2DASH'){
            steps{
                script{
                    sh """
                        docker run --rm -v "${DOCS_PATH}":/work "$IMAGE_NAME" build  && \
                        sleep 5
                    """`
                }
            }
            steps{
                script{
                    sh """
                    mkdir ${DOC_PATH}/Redbeard28 && \
                    python html2dash.py -n ${DOCSET_NAME} -d ${DOC_PATH}/Redbeard28 -i docs_src/images/icon.png docs && \
                    cp docs_src/images/favicon.ico ${DOC_PATH}/Redbeard28/redbeard28.docset/icon.ico
                    """
                }
            }
        
        }
    }
}
void close_container() {
    sh '$container_id=$(docker container ls|grep ${docker_mkdocs_image}|awk \'{ print $1 }\') ; docker container stop  $container_id'
}

void